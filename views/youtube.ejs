<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/typeahead.bundle.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/typeahead.css" />
    <style type="text/css">
        body {background: #202124 !important;}
    </style>
</head>
  <body>
      
    <div class="d-flex justify-content-center">
        <div class="p-2" id="remote">
            <form id="searchForm" class="form-inline">
              <input class="form-control typeahead tt-query" type="text" id="searchYoutube" name="search" placeholder="Search for a song" autocomplete="off">
            </form>
        </div>
        <div class="p-2" id="remoteButton">
            <button type="button" id="searchButton" class="btn btn-dark btn-md">Add to queue</button>
        </div>
        
    </div>  
    
    <div class="container" style="max-width: 1280px;">
      <div class="row justify-content-center">
        <div class="col" id="videoQueue">
          
        </div>
        <div class="col-xl-14" id="player"></div><br>
        <div class="w-100"></div>
        <div class="alert alert-success ml-auto" id="success-alert" style="display: none">
            <button type="button" class="close mr-auto" data-dismiss="alert"></button>
            <strong>Success! </strong>
            Song added to queue
        </div> 
        <button type="button" id="nextButton" class="btn btn-success btn-md ml-auto mb-auto">Next Song</button>
        
      </div>
    </div>
    <div class="container">
      <div class="row align-items-end">
        <div class="alert alert-success" id="success-alert" style="display: none">
            <button type="button" class="close" data-dismiss="alert">x</button>
            <strong>Success! </strong>
            Added to queue
        </div> 
      </div>
    </div>
        
    
    <script>
      
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      var videoId = "<%=data.videoId%>";
      var queue = [];

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '720',
          width: '1280',
          videoId: videoId,
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
          }
        });
      }

      function onPlayerStateChange(event) { 
        if(event.data === YT.PlayerState.ENDED) {
          if(queue.length === 0) {
            player.seekTo(0, true); //restarts the current video if no songs in queue
          }
          else {
            videoId = queue.shift() //removes queueArr[0] from array and returns it's value
            updateVideo(videoId);
          }
        }
      }

      function onPlayerReady(event) {
        event.target.setVolume(25);
        event.target.playVideo();
      }

      function updateVideo(videoId) {
        player.loadVideoById({
            videoId: videoId,
            suggestedQuality: 'hd720',
          });
      }

      $(document).ready(function() {
        
        let songs = new Bloodhound({
          datumTokenizer: Bloodhound.tokenizers.whitespace,
          queryTokenizer: Bloodhound.tokenizers.whitespace,
          remote: {
              url: '/api/search?key=%QUERY',
              wildcard: '%QUERY'
          }
        });

        var th = $('#remote .form-control').typeahead({
          hint: true,
          highlight: true,
          minLength: 1,
        }, 
        {
          name: 'songs',
          display: function(data) {
              return data.song_name + ' - ' + data.artist_name;
          },
          limit: Infinity,  //limit is controlled by the backend
          source: songs,
        }).on('typeahead:selected', function(e, data) {
          submitSearch(data.youtube_id);
          th.typeahead('val',''); //resets the form to empty string
        })
      });

    $(function(){
      $(document).on('click','input[type=text]',function(){ this.select(); });
    });
    document.getElementById('searchYoutube').onkeypress = function(e) {
      if(!e) e = window.event;
      var keyCode = e.keyCode || e.which;
      if(keyCode == '13') {
        submitSearch(null);
        return false;
      }
    }
    document.getElementById('searchButton').onclick = function() {
      submitSearch(null);
    };

    document.getElementById('nextButton').onclick = function() {
      onPlayerStateChange({data: YT.PlayerState.ENDED});
    };

    function submitSearch(videoId) {
      $("#success-alert").css("display", "block").fadeTo(2000, 500).slideUp(500, function(){
      $("#success-alert").slideUp(500);
      });   
      let text = document.getElementById("searchYoutube").value;
      let search = text;
      if(!videoId) {
        req = new XMLHttpRequest();
        req.open("GET", 'api/youtube/search?search=' + search, true);
        req.send();
        req.onload=function(){
            json=JSON.parse(req.responseText);
            queue.push(json.videoId);
        }
      }
      else {
        queue.push(videoId);
      }
    }
    
    </script>
  </body>
</html>